package cz.mzk.recordmanager.server.index.enrich;

import org.apache.solr.common.SolrInputDocument;
import org.apache.solr.common.SolrInputField;

import java.util.*;

public class FieldMerger {

	private final List<String> fields;

	public FieldMerger(String field) {
		super();
		this.fields = Collections.singletonList(field);
	}

	public FieldMerger(String... fields) {
		super();
		this.fields = Arrays.asList(fields);
	}

	public void mergeAndRemoveFromSources(List<SolrInputDocument> source,
			SolrInputDocument target) {
		merge(source, target);
		for (String field : fields) {
			source.stream().forEach(doc -> doc.remove(field));
		}
	}

	public void merge(List<SolrInputDocument> source,
			SolrInputDocument target) {
		for (String field : fields) {
			Set<Object> values = new HashSet<>();
			source.stream()
					.map(rec -> rec.getFieldValues(field))
					.filter(rec -> rec != null)
					.forEach(rec -> values.addAll(rec));
			target.setField(field, values);
		}
	}

	public void renameField(SolrInputDocument source, String oldName, String newName) {
		SolrInputField field = source.remove(oldName);
		if (field != null) {
			source.addField(newName, field.getValueCount() == 1 ? field.getValue() : field.getValues());
		}
	}

	public void copyField(SolrInputDocument doc, String sourceName, String targetName) {
		if (doc.containsKey(sourceName)) doc.addField(targetName, doc.getField(sourceName));
	}

}
